# Общие правила работы с проектом для ИИ-ассистента

**Язык общения — русский.**

**Удалённый сервер.** Проект развёрнут на удалённом сервере.
SSH: `ssh -p 1024 host1860015@serv21.hostland.ru`
Корень сайта: `/home/host1860015/modx3.art-sites.ru/htdocs/www`
PHP-скрипты и SQL-запросы выполнять на удалённом сервере через SSH.

**Тестовый сайт** лежит `/home/host1860015/modx3.art-sites.ru/htdocs/test`
БД: host1860015_testmodx3
Пароль: ZcS23Dq5

**Критическое мышление.** Спорь с пользователем, если видишь ошибку в его рассуждениях. Доказывай свою точку зрения. Подсвечивай неочевидные факты, edge cases и потенциальные
проблемы.

**Code review обязателен.** Перед любыми значительными изменениями проводи ревью существующего кода — изучи связанные файлы, пойми контекст, проверь возможные побочные
эффекты.

**Честность.** Если не знаешь ответа — скажи «Я не знаю». Не выдумывай. Не строй догадки. Можешь предложить гипотезы для проверки, но явно обозначь их как гипотезы.

**Сначала составь план работ** Перед написанием кода составь подробный план того, что собираешься сделать и начинай писать код только после одобрения пользователя.

**При внесении изменений отслеживай возможное их влияние на другие участки кода и логику приложения в целом и вноси изменения так, чтобы ничего не ломалось**

**Всегда проверяй соответствует ли твой код правилам изложенным в этом файле**

**При написании кода строго следовать принципам SOLID и DRY**

**Не пиши комментариев в коде. Всю логику работы кода отражай в файле /core/components/packagename/docs/readme.txt**

**Задавай уточняющие вопросы, если что-то непонятно или есть сомнения в правильности решения**

# Требования в PHP-коду:

1. PHP 8.1+
2. PSR-12, PSR-4 автозагрузка
3. Типизация: везде где возможно
4. Каждая функция или метод должны иметь DocBlock с указанием типов входных и выходных данных, строго без каких либо комментарием.
5. Файл начинается с DocBlock комментария, описывающего назначение кода в файле.
6. Функция не должна получать на вход больше 3-х аргументов, если нужно больше заменить на входящий массив.

# Требования в JavaScript-коду:

1. Использовать ES6 классы
2. Экспорт по умолчанию: export default class ClassName
3. Название класса с заглавной буквы (PascalCase)
4. Файл называется в соответствии с именем класса (MainHandler → mainhandler.js)

# Требования к архитектуре:

1. Вся бизнес-логтика находится в папке src/
2. Все элементы MODX использовать сервисы из папки src/
3. Все системные плагины MODX работают через единую точку входа core/components/vehiclespecmatch/elements/plugins/switch.php
   при этом класс плагина должен называться так же как и событие на которое он реагирует
   и обязан содержать публичный метод run()

# Специфика MODX Revolution:

1. Использовать modX::getService для сервисов
2. События через $modx->invokeEvent()
3. Кэширование через modCacheManager
4. Лексиконы для всех строк интерфейса
5. Современные процессоры (отдельные классы)
6. Получение объектов $modx->getObject()
7. Получение коллекций объектов $modx->getIterator(), не getCollection()
8. Подключение модели компонента через $modx->addPackage()
9. Запросы к БД через XPDO
10. Все шаблоны и чанки имеют расширение .tpl и используют синтаксис Fenom
11. Рендер чанков с помощью $modx->getParser()->pdoTools->getChunk()
12. Ключи словарей должны быть в формате snake_case
13. Значения получаемые через $modx->getOption() могут быть только строками, числами и булевыми.

# Правила для схем таблиц в БД:

1. XML схема в model/schema/packagename.mysql.schema.xml
2. Имена таблиц с префиксом modx_dbprefix_
3. Индексы для часто запрашиваемых полей
4. Внешние ключи для связей
5. Классы модели в model/packagename/

**Пример схемы**:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<model package="packagename" baseClass="xPDOObject" platform="mysql" defaultEngine="InnoDB" version="1.1">
   <object class="objectClassName" table="package_tablename" extends="xPDOSimpleObject">
      <field key="vehicle_type" dbtype="varchar" precision="50" phptype="string" null="false" default="car" index="index" />
      <field key="brand" dbtype="varchar" precision="50" phptype="string" null="false" index="index" />
      <field key="model" dbtype="varchar" precision="50" phptype="string" null="false" index="index" />
      <field key="start_year" dbtype="int" precision="4" attributes="unsigned" phptype="integer" null="false" index="index" />
      <field key="body_type" dbtype="varchar" precision="50" phptype="string" null="true" index="index" />
      <field key="config" dbtype="varchar" precision="50" phptype="string" null="true" index="index" />
      <field key="end_year" dbtype="int" precision="4" attributes="unsigned" phptype="integer" null="true" index="index" />
      <field key="title" dbtype="varchar" precision="255" phptype="string" null="false" index="unique" />
      <field key="image" dbtype="text" phptype="string" null="true" />

      <index alias="title" name="title" primary="false" unique="true" type="BTREE" >
         <column key="title" length="" collation="A" null="false" />
      </index>
   </object>
</model>
```

# Правила именования файлов

1. PHP файлы несвязанные из папки core/components/packagename/src/ именуются в стиле snake_case
2. Медиа файлы именуются в стиле kebek-case
3. Остальные файлы именуются в стиле snake_case
4. Файлы сторонних библиотек не переименовываются
5. В именах файлов не должно быть кириллицы, пробелов и спецсимволов.

# Документация:

1. core/components/packagename/docs/readme.txt - тут описание принципов работы и инструкция по использованию
2. core/components/packagename/docs/changelog.txt - тут список изменений по версиям, версии меняются перед каждым коммитом

# Правила анализа кода:

1. Совместимость с MODX 3
2. Корректность работы с xPDO
3. Обработку ошибок и исключений
4. Безопасность (SQL-инъекции, XSS)
5. Производительность запросов
6. Использование лексиконов для всех строк
7. Корректность событий плагинов
8. Оптимизацию кэширования

# При предложении решений:

1. Предлагать модульную архитектуру
2. Учитывать возможные расширения
3. Добавлять хуки для кастомизации
4. Предусматривать миграции данных
5. Обеспечивать обратную совместимость, если версия имеет постфикс не pl и не rc.

# Ключевые принципы:

1. Расширяемость: хуки, события, плагины
2. Производительность: кэширование, индексы
3. Безопасность: валидация, санитизация
4. Юзер-экспириенс: понятные ошибки, локализация
5. Поддержка: логирование, дебаг-режим
